<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- LForms CSS -->
    <link href="https://clinicaltables.nlm.nih.gov/lforms-versions/34.0.0/webcomponent/styles.css" media="screen" rel="stylesheet" />
    <title>Form</title>
  </head>
  <body>
    <button id="backBtn" class="btn btn-secondary mt-3 mb-3">Back to Home</button>  
    <div id="formContainer"></div>
    
      <button type="button" id="downloadBtn" class="btn btn-primary mt-3">Download JSON</button>
      <button type="button" id="pushBtn" class="btn btn-primary mt-3">Push to FHIR Server</button>
        <!-- LForms Scripts -->
    <script src="https://clinicaltables.nlm.nih.gov/lforms-versions/34.0.0/webcomponent/assets/lib/zone.min.js"></script>
    <script src="https://clinicaltables.nlm.nih.gov/lforms-versions/34.0.0/webcomponent/lhc-forms.js"></script>
    <script src="https://clinicaltables.nlm.nih.gov/lforms-versions/34.0.0/fhir/lformsFHIRAll.min.js"></script>

    <script>

        document.getElementById('backBtn').addEventListener('click', function() {
            window.location.href = '/';
            });

        let formDef = null;
        let formUrl = '{{ form_url }}';
        let endpointUrl = new URLSearchParams(window.location.search).get('endpoint_url');    

        fetch(formUrl)
        .then(response => response.json())
        .then(data => {
            formDef = data;
            LForms.Util.addFormToPage(formDef, 'formContainer');
        })
        .catch((error) => {
            console.error('Error:', error);
        });
      
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (formDef) {
                const questionnaireResponse = LForms.Util.getFormFHIRData('QuestionnaireResponse', 'R4', 'formContainer', ['extract']);
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questionnaireResponse));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "questionnaire_response.json");
                document.body.appendChild(downloadAnchorNode); // required for firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
        });
      
        document.getElementById('pushBtn').addEventListener('click', function() {
                
            if (formDef) {
            const questionnaireResponse = LForms.Util.getFormFHIRData('QuestionnaireResponse', 'R4', 'formContainer');
            questionnaireResponse.questionnaire = formUrl;

            fetch(endpointUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/fhir+json'
                },
                body: JSON.stringify(questionnaireResponse)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                alert('QuestionnaireResponse successfully pushed to the FHIR server.');
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while pushing the QuestionnaireResponse to the FHIR server.');
            });
        }
    });
  </script>
  </body>
</html>
